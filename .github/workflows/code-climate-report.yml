name: Code Climate Report

on:
  push:
    branches:
      - main
      - publish-playwright-reports
  schedule:
    - cron: "30 01 * * *"
  workflow_dispatch:

permissions:
  contents: write
  actions: read

env:
  JSON_ARTIFACT_ID: json-main-coverage-report
  HTML_ARTIFACT_ID: html-main-coverage-report

jobs:
  coverage-report:
    runs-on: ubuntu-20.04
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          ref: main
      - uses: ./.github/actions/setup
      - name: Test
        continue-on-error: true
        run: run test --coverage
      - name: Report coverage to Code Climate
        if: always()
        uses: paambaati/codeclimate-action@v9.0.0
        env:
          CC_TEST_REPORTER_ID: ${{ secrets.CC_TEST_REPORTER_ID }}
        with:
          coverageLocations: coverage/lcov.info:lcov
      - name: Upload Coverage Summary
        if: ${{ !cancelled() }}
        uses: actions/upload-artifact@v4
        id: upload-json
        with:
          name: ${{ env.JSON_ARTIFACT_ID }}
          path: coverage/coverage-summary.json
          overwrite: true
          retention-days: 90
      - name: Upload Coverage Report
        if: ${{ !cancelled() }}
        uses: actions/upload-artifact@v4
        id: upload-html
        with:
          name: ${{ env.HTML_ARTIFACT_ID }}
          path: coverage/html-report/
          overwrite: true
          retention-days: 90

  publish:
    needs: [coverage-report]
    runs-on: ubuntu-20.04
    steps:
      - name: Checkout GitHub Pages Branch
        uses: actions/checkout@v4
        with:
          ref: gh-pages
      - name: Download JSON Report
        uses: actions/download-artifact@v4
        with:
          name: ${{ env.JSON_ARTIFACT_ID }}
          path: _data/coverage/
      - name: Download HTML Report
        uses: actions/download-artifact@v4
        with:
          name: ${{ env.HTML_ARTIFACT_ID }}
          path: coverage/
      - name: Push to GitHub Pages Branch
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
          git add .
          git commit -m "update code coverage report for main"
          git pull origin gh-pages --rebase -s recursive -X ours
          git push
          echo "Report URL: https://enterprise-cmcs.github.io/macpro-mako/coverage/" >> "$GITHUB_STEP_SUMMARY"
