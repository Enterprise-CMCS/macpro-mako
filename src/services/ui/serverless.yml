service: ${self:custom.project}-ui-src

frameworkVersion: "3"

plugins:
  - serverless-plugin-scripts
  - serverless-s3-sync
  - serverless-cloudfront-invalidate
  - serverless-stack-termination-protection
  - "@stratiformdigital/serverless-s3-security-helper"

provider:
  name: aws
  runtime: nodejs18.x
  region: us-east-1
  stackTags:
    PROJECT: ${self:custom.project}
    SERVICE: ${self:service}
  environment:
    BOOTSTRAP_USERS_PW: ${param:BootstrapUsersPassword}

custom:
  project: ${env:PROJECT}
  stage: ${opt:stage, self:provider.stage}
  region: ${opt:region, self:provider.region}
  serverlessTerminationProtection:
    stages:
      - master
      - val
      - production
  s3Sync:
    - bucketName: ${param:S3BucketName}
      localDir: ./dist
      deleteRemoved: true
  cloudfrontInvalidate:
    - distributionId: ${param:CloudfrontDistributionId}
      items:
        - "/*"
  scripts:
    hooks:
      package:initialize: |
        set -e
        echo "Current working directory:"
        pwd
        echo "Generating .env.local file..."
        echo """
        VITE_API_REGION=${param:ApiRegion}
        VITE_API_URL=${param:ApiUrl}
        VITE_NODE_ENV=${self:custom.stage}
        VITE_COGNITO_REGION=${param:CognitoRegion}
        VITE_COGNITO_IDENTITY_POOL_ID=${param:CognitoIdentityPoolId}
        VITE_COGNITO_USER_POOL_ID=${param:CognitoUserPoolId}
        VITE_COGNITO_USER_POOL_CLIENT_ID=${param:CognitoUserPoolClientId}
        VITE_COGNITO_USER_POOL_CLIENT_DOMAIN=${param:CognitoUserPoolClientDomain}
        VITE_COGNITO_REDIRECT_SIGNIN=${param:ApplicationEndpointUrl}
        VITE_COGNITO_REDIRECT_SIGNOUT=${param:ApplicationEndpointUrl}
        BOOTSTRAP_USERS_PW=${param:BootstrapUsersPassword}
        """ > .env.local
        echo ".env.local content:"
        cat .env.local  # Print the content of .env.local
        chmod 644 .env.local  # Set more generous permissions (rw-r--r--) on .env.local
        echo ".env.local file generated successfully."
        yarn build
    commands:
      useLocalhost: |
        sed -i '' -e 's|VITE_COGNITO_REDIRECT_SIGNIN=.*|VITE_COGNITO_REDIRECT_SIGNIN=http://localhost:5000/|g' .env.local
        sed -i '' -e 's|VITE_COGNITO_REDIRECT_SIGNOUT=.*|VITE_COGNITO_REDIRECT_SIGNOUT=http://localhost:5000/|g' .env.local
